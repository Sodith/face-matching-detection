<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Face Detection</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
    body {
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    background-color: #f0f0f0;
    min-height: 100vh;
    box-sizing: border-box;
    margin: 0;
}

.container {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    text-align: center;
    max-width: 800px;
    width: 100%;
    box-sizing: border-box;
}

.video-container {
    position: relative;
    width: 100%;
    max-width: 640px;
    margin: 20px auto;
    aspect-ratio: 4/3;
    border-radius: 10px;
    overflow: hidden;
    background-color: #000;
}

video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 10px;
    transition: opacity 0.5s ease-in-out;
    z-index: 1;
}

#lastFrame {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 10px;
    transition: opacity 0.5s ease-in-out;
    opacity: 0;
    z-index: 2;
}

#overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    border-radius: 10px;
    z-index: 3;
}

.controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    margin: 15px 0;
}

input {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 16px;
    min-width: 200px;
    outline: none;
    transition: border-color 0.3s;
}

input:focus {
    border-color: #007bff;
}

button {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
    background-color: #007bff;
    color: #fff;
    transition: background-color 0.3s, transform 0.1s;
    min-width: 120px;
}

button:hover {
    background-color: #0056b3;
}

button:active {
    transform: scale(0.98);
}

button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
    transform: none;
}

#stopButton {
    background-color: #dc3545;
}

#stopButton:hover {
    background-color: #c82333;
}

#matchButton {
    background-color: #28a745;
}

#matchButton:hover {
    background-color: #218838;
}

h1 {
    color: #333;
    margin: 0 0 20px 0;
    font-size: 24px;
}

p {
    color: #666;
    margin: 10px 0;
    line-height: 1.5;
}

#status {
    padding: 10px;
    border-radius: 5px;
    background-color: #f8f9fa;
    margin-top: 15px;
}

/* Loading indicator for the video container */
.video-container::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 40px;
    height: 40px;
    margin: -20px 0 0 -20px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    z-index: 0;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Media Queries for Responsiveness */
@media (max-width: 768px) {
    .container {
        padding: 15px;
        margin: 10px;
    }

    .video-container {
        margin: 15px auto;
    }

    h1 {
        font-size: 20px;
    }

    input, button {
        font-size: 14px;
        padding: 8px;
    }

    .controls {
        flex-direction: column;
        align-items: stretch;
    }

    input {
        min-width: unset;
        width: 100%;
    }
}

/* For very small screens */
@media (max-width: 480px) {
    body {
        padding: 10px;
    }

    .container {
        padding: 10px;
    }

    h1 {
        font-size: 18px;
        margin-bottom: 15px;
    }

    .video-container {
        margin: 10px auto;
    }
}

/* High contrast mode support */
@media (prefers-contrast: high) {
    .container {
        border: 2px solid #000;
    }

    button {
        outline: 2px solid transparent;
    }

    button:focus {
        outline: 2px solid #000;
    }
}
  </style>
</head>
<body>
  <div class="container">
    <h1>Face Detection</h1>
    <input type="text" id="username" placeholder="Enter your name">
    <button id="startButton" disabled>Start Capture</button>
    <button id="stopButton" disabled>Stop Capture</button>
    <button id="matchButton" onclick="window.location.href='match.html'">Match Face</button>
    
    <div class="video-container">
      <video id="video" autoplay></video>
      <canvas id="overlay"></canvas>
      <img id="lastFrame" alt="Last captured frame" />
    </div>
    
    <p id="status">Waiting to start...</p>
  </div>

  <script>
    let socket = io("http://localhost:5000");
   // working code---
    // const video = document.getElementById("video");
    // const overlay = document.getElementById("overlay");
    // const lastFrame = document.getElementById("lastFrame");
    // const statusText = document.getElementById("status");
    // const startButton = document.getElementById("startButton");
    // const stopButton = document.getElementById("stopButton");
    // const matchButton = document.getElementById("matchButton");
    // const usernameInput = document.getElementById("username");
    // let stream = null;
    // let captureInterval = null;
    // let frameCount = 0;

    // // Initialize overlay canvas
    // function initializeOverlay() {
    //   overlay.width = 640;
    //   overlay.height = 480;
    // }
    // initializeOverlay();

    // socket.on("face_detected", (faceData) => {
    //   const ctx = overlay.getContext('2d');
    //   ctx.clearRect(0, 0, overlay.width, overlay.height);

    //   if (faceData) {
    //     ctx.strokeStyle = '#00ff00';
    //     ctx.lineWidth = 3;
    //     ctx.strokeRect(faceData.x, faceData.y, faceData.width, faceData.height);
    //   }
    // });

    // usernameInput.addEventListener("input", () => {
    //   startButton.disabled = !usernameInput.value.trim();
    // });

    // startButton.addEventListener("click", () => {
    //   const username = usernameInput.value.trim();
    //   if (username) {
    //     socket.emit("start_capture", { username });
    //     startButton.disabled = true;
    //     stopButton.disabled = false;
    //     matchButton.disabled = true;

    //     navigator.mediaDevices
    //       .getUserMedia({ 
    //         video: {
    //           width: { ideal: 640 },
    //           height: { ideal: 480 }
    //         }
    //       })
    //       .then((mediaStream) => {
    //         stream = mediaStream;
    //         video.srcObject = stream;
    //         lastFrame.style.opacity = "0";
    //         video.style.opacity = "1";

    //         const canvas = document.createElement("canvas");
    //         canvas.width = 640;
    //         canvas.height = 480;
    //         const context = canvas.getContext("2d");

    //         captureInterval = setInterval(() => {
    //           if (!stream.active) return;
    //           context.drawImage(video, 0, 0, canvas.width, canvas.height);
    //           const imageData = canvas.toDataURL("image/jpeg", 0.8);
    //           socket.emit("send_frame", { image: imageData, username: username });
    //         }, 100);
    //       })
    //       .catch((err) => {
    //         console.error("Error accessing webcam:", err);
    //         statusText.textContent = "Error accessing webcam.";
    //       });
    //   }
    // }); // working code---
    const video = document.getElementById("video");
const overlay = document.getElementById("overlay");
const lastFrame = document.getElementById("lastFrame");
const statusText = document.getElementById("status");
const startButton = document.getElementById("startButton");
const stopButton = document.getElementById("stopButton");
const matchButton = document.getElementById("matchButton");
const usernameInput = document.getElementById("username");
const frameCounter = document.createElement("div"); // New counter element
let stream = null;
let isCapturing = false;
let framesSent = 0; // Counter for frames sent
let startTime = null; // For FPS calculation

// Style the frame counter
frameCounter.style.position = "absolute";
frameCounter.style.top = "10px";
frameCounter.style.left = "10px";
frameCounter.style.background = "rgba(0, 0, 0, 0.7)";
frameCounter.style.color = "white";
frameCounter.style.padding = "5px 10px";
frameCounter.style.borderRadius = "5px";
frameCounter.style.zIndex = "2";
document.body.appendChild(frameCounter);

// Initialize overlay canvas
function initializeOverlay() {
  overlay.width = 640;
  overlay.height = 480;
}
initializeOverlay();

// Update counter display
function updateCounterDisplay() {
  const currentTime = (Date.now() - startTime) / 1000; // Time in seconds
  const fps = (framesSent / currentTime).toFixed(1);
  frameCounter.textContent = `Frames: ${framesSent} | FPS: ${fps}`;
}

// We'll now handle the processed frames from the backend
socket.on("status", (data) => {
  statusText.textContent = data.message;
  
  // Display the processed frame if it exists
  if (data.image) {
    const img = new Image();
    img.onload = () => {
      const ctx = overlay.getContext('2d');
      ctx.clearRect(0, 0, overlay.width, overlay.height);
      ctx.drawImage(img, 0, 0, overlay.width, overlay.height);
    };
    img.src = data.image;
  }

  if (data.completed) {
    isCapturing = false;
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }
    startButton.disabled = false;
    stopButton.disabled = true;
    matchButton.disabled = false;
    
    // Display final stats
    const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);
    const averageFps = (framesSent / totalTime).toFixed(1);
    frameCounter.textContent = `Total Frames: ${framesSent} | Time: ${totalTime}s | Avg FPS: ${averageFps}`;
    
    // Display the last frame if it exists
    if (data.image) {
      video.style.opacity = "0";
      lastFrame.src = data.image;
      lastFrame.style.opacity = "1";
    }
  }
});

usernameInput.addEventListener("input", () => {
  startButton.disabled = !usernameInput.value.trim();
});

function captureAndSendFrame(context, canvas, username) {
  if (!isCapturing || !stream.active) return;
  
  context.drawImage(video, 0, 0, canvas.width, canvas.height);
  const imageData = canvas.toDataURL("image/jpeg", 0.8);
  socket.emit("send_frame", { image: imageData, username: username });
  
  // Increment frame counter and update display
  framesSent++;
  updateCounterDisplay();
  
  // Request next frame only if we're still capturing
  if (isCapturing) {
    requestAnimationFrame(() => captureAndSendFrame(context, canvas, username));
  }
}

startButton.addEventListener("click", () => {
  const username = usernameInput.value.trim();
  if (username) {
    // Reset counters
    framesSent = 0;
    startTime = Date.now();
    frameCounter.textContent = "Frames: 0 | FPS: 0.0";
    
    socket.emit("start_capture", { username });
    startButton.disabled = true;
    stopButton.disabled = false;
    matchButton.disabled = true;
    isCapturing = true;

    // Clear the overlay
    const ctx = overlay.getContext('2d');
    ctx.clearRect(0, 0, overlay.width, overlay.height);

    navigator.mediaDevices
      .getUserMedia({ 
        video: {
          width: { ideal: 640 },
          height: { ideal: 480 }
        }
      })
      .then((mediaStream) => {
        stream = mediaStream;
        video.srcObject = stream;
        lastFrame.style.opacity = "0";
        video.style.opacity = "1";

        const canvas = document.createElement("canvas");
        canvas.width = 640;
        canvas.height = 480;
        const context = canvas.getContext("2d");

        // Start the capture loop
        captureAndSendFrame(context, canvas, username);
      })
      .catch((err) => {
        console.error("Error accessing webcam:", err);
        statusText.textContent = "Error accessing webcam.";
        isCapturing = false;
        startButton.disabled = false;
        stopButton.disabled = true;
      });
  }
});

// stopButton.addEventListener("click", () => {
//   isCapturing = false;
//   if (stream) {
//     stream.getTracks().forEach(track => track.stop());
//   }
//   startButton.disabled = false;
//   stopButton.disabled = true;
//   matchButton.disabled = false;
  
//   // Display final stats
//   const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);
//   const averageFps = (framesSent / totalTime).toFixed(1);
//   frameCounter.textContent = `Total Frames: ${framesSent} | Time: ${totalTime}s | Avg FPS: ${averageFps}`;
// });
// startButton.addEventListener("click", () => {
//   console.log("startButton clicked");
//   const username = usernameInput.value.trim();
//   if (username) {
//     socket.emit("start_capture", { username });
//     console.log("start_capture emitted");
//     startButton.disabled = true;
//     stopButton.disabled = false;
//     matchButton.disabled = true;

//     navigator.mediaDevices
//       .getUserMedia({
//         video: {
//           width: { ideal: 640 },
//           height: { ideal: 480 }
//         }
//       })
//       .then((mediaStream) => {
//         stream = mediaStream;
//         video.srcObject = stream;
//         lastFrame.style.opacity = "0";
//         video.style.opacity = "1";

//         const canvas = document.createElement("canvas");
//         canvas.width = 640;
//         canvas.height = 480;
//         const context = canvas.getContext("2d");
//         console.log("stream:", stream);
//         function captureAndSendFrame() {
//           if (!stream.active) return;
//            console.log("stream.active:", stream.active);
//           context.drawImage(video, 0, 0, canvas.width, canvas.height);
//           const imageData = canvas.toDataURL("image/jpeg", 0.8);
//           socket.emit("send_frame", { image: imageData, username: username });
//           console.log("frame sended");
//         }

//         // Listen for status events from server
//         socket.on("status", (data) => {
//           console.log("Received status:", data);
//           if (!data.completed) {
//             // Continue capturing if not completed
//             console.log("status111:", data.completed);
//             requestAnimationFrame(captureAndSendFrame);
//           } else {
//             // Stop capturing when completed
//             console.log("status22:", data.completed);
//             stream.getTracks().forEach(track => track.stop());
//             startButton.disabled = false;
//             stopButton.disabled = true;
//           }
//         });
//         console.log("Starting initial hj,kjhjcapture");
//         // Start initial capture
//         captureAndSendFrame();
//       })
//       .catch((err) => {
//         console.error("Error accessing webcam:", err);
//         statusText.textContent = "Error accessing webcam.";
//       });
//   }
// });
   
    stopButton.addEventListener("click", () => {
        socket.emit("stop_capture");
        startButton.disabled = false;
        stopButton.disabled = true;
        matchButton.disabled = false;

        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }

        if (captureInterval) {
            clearInterval(captureInterval);
            captureInterval = null;
        }
    });

    // Replace your existing socket.on("status") with this:
socket.on("status", (data) => {
    statusText.textContent = data.message;

    if (data.completed) {
        // Convert the image data to base64 if needed
        const frameData = data.image;
        const faceCoords = data.face_coords;

        // Stop video stream gracefully
        if (stream) {
            stream.getTracks().forEach(track => {
                track.stop();
            });
            stream = null;
        }

        if (captureInterval) {
            clearInterval(captureInterval);
            captureInterval = null;
        }

        // Show the final frame with face detection
        showFinalFrame(frameData, faceCoords);
        popup("Face capture completed!");
        // alert("Face capture completed!");
       socket.disconnect();
    }
});

// Add this new function to handle the final frame display
function showFinalFrame(frameData, faceCoords) {
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    const img = new Image();

    img.onload = () => {
        canvas.width = 640;  // Match your video dimensions
        canvas.height = 480;

        // Draw the base image
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        // Draw the face detection box
        if (faceCoords) {
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 3;
            ctx.strokeRect(
                faceCoords.x,
                faceCoords.y,
                faceCoords.width,
                faceCoords.height
            );
        }

        // Apply the final frame to the lastFrame element
        lastFrame.src = canvas.toDataURL();

        // Create smooth transition
        requestAnimationFrame(() => {
            video.style.opacity = "0";
            lastFrame.style.opacity = "1";
        });
    };

    img.src = frameData;
}

    socket.on("match_result", (data) => {
      alert(`Match result: ${data.result}`);
    });

    socket.on("connect_error", (err) => {
      console.error("WebSocket connection error:", err);
      statusText.textContent = "WebSocket connection error.";
    });
  </script>
</body>
</html>